"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.wkb_generation = wkb_generation;
exports.centroid_extraction = centroid_extraction;
exports.simplification = simplification;
exports.pointSampling = pointSampling;
exports.meshcode_generalization = meshcode_generalization;
exports.meshcode_generation = meshcode_generation;
exports.meshcode_aggregation = meshcode_aggregation;
exports.buffering = buffering;
exports.spatial_masking = spatial_masking;
exports.spatial_join = spatial_join;
exports.spatial_masking_by_geometry = spatial_masking_by_geometry;
exports.batch_spatial_geometry_filter = batch_spatial_geometry_filter;

var _datasetExtensionUtils = require("../dataset-extension-utils");

var _visStateActions = require("../../actions/vis-state-actions");

var _dataProcessor = require("../../processors/data-processor");

var _defaultSettings = require("../../constants/default-settings");

var turf = _interopRequireWildcard(require("@turf/turf"));

// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
function wkb_generation(dataset, attrs) {
  var geom_col = attrs.geom_col,
      outColumn = attrs.outColumn;
  console.log('run wkb generating');
  var gdf = (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(dataset, geom_col);
  gdf.toWkb();
  var wkb_list = {
    analyzerType: "STRING",
    displayName: outColumn,
    fieldIdx: dataset.fields.length,
    format: "",
    id: outColumn,
    name: outColumn,
    type: "string"
  };
  dataset.dataContainer._rows = gdf.toArray();
  dataset.fields.push(wkb_list);
  dataset.dataContainer._numColumns = dataset.dataContainer._numColumns + 1;
  return dataset;
}

function centroid_extraction(dataset, col_id) {}

function simplification() {}

function pointSampling() {}

function meshcode_generalization() {
  (0, _visStateActions.addTableColumn)();
}

function meshcode_generation(dataset, attr) {
  var geom_col = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '_geojson';
  var gdf = (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(dataset, geom_col);
} //难度：需要添加layer,如何进行更新？


function meshcode_aggregation(dataset, attr) {
  var geom_col = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '_geojson';
} //todo: buffering spatial data;


function buffering(dataset, attr) {
  var geom_col = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '_geojson';
} //there are several functions


function spatial_masking(oriDataset, joinDataset, how, replace, geomCol, joinGeomCol) {
  console.log('spatial masking');
  var gdf = Array.isArray(geomCol) ? (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(oriDataset, null, geomCol[0], geomCol[1]) : (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(oriDataset, geomCol);
  var joint_gdf = (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(joinDataset, joinGeomCol);
  var geom_union = joint_gdf.union();
  var out_gdf = how === 'contain' ? gdf.contains(geom_union) : 'within' ? gdf.within(geom_union) : 'intersect' ? gdf.intersects(geom_union) : null;
  return (0, _dataProcessor.processCsvData)(out_gdf.toArray(), out_gdf.listColumns());
} //todo: spatial join


function spatial_join(oriDataset, joinDataset, how, replace, geomCol, joinGeomCol) {}

function spatial_masking_by_geometry(dataSet, geomCol, jointGeometry) {
  var how = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 'contains';
  var drop_geom = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;
  var gdf = (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(dataSet, geomCol);
  var out_gdf = how === 'contain' ? gdf.contains(jointGeometry) : 'within' ? gdf.within(jointGeometry) : 'intersect' ? gdf.intersects(jointGeometry) : null;
  dataSet.dataContainer._rows = drop_geom ? out_gdf.df.drop(out_gdf.geom_col).toArray() : out_gdf.df.toArray();
  return dataSet;
} // export function spatial_join


function batch_spatial_geometry_filter(datasets, geometryFilter, oddataID, gpsdataID, poidataID) {
  console.log('batch geometry filter');
  var filter_geom = turf.feature(_defaultSettings.GEOMETRY_RANGE[geometryFilter].geometry);

  if (oddataID) {
    var geom_cols = _defaultSettings.DATASET_COLUMNS['oddata']['gps'].concat(_defaultSettings.DATASET_COLUMNS['oddata']['geometry']);

    datasets[oddataID] = (0, _datasetExtensionUtils.reset_index_dataset)(geom_cols.reduce(function (ds, col) {
      return spatial_masking_by_geometry(ds, col, filter_geom, 'contains', Array.isArray(col));
    }, datasets[oddataID]));
  }

  if (gpsdataID) {
    var _geom_cols = _defaultSettings.DATASET_COLUMNS['gpsdata']['gps'];
    datasets[gpsdataID] = (0, _datasetExtensionUtils.reset_index_dataset)(_geom_cols.reduce(function (ds, col) {
      return spatial_masking_by_geometry(ds, col, filter_geom, 'contains', Array.isArray(col));
    }, datasets[gpsdataID]));
  }

  if (poidataID) {
    var _geom_cols2 = _defaultSettings.DATASET_COLUMNS['poidata']['gps'];
    datasets[poidataID] = (0, _datasetExtensionUtils.reset_index_dataset)(_geom_cols2.reduce(function (ds, col) {
      return spatial_masking_by_geometry(ds, col, filter_geom, 'contains', Array.isArray(col));
    }, datasets[poidataID]));
  }

  return datasets;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9wcm9jZXNzb3ItdXRpbHMvc3BhdGlhbC1wcm9jZXNzb3ItdXRpbHMuanMiXSwibmFtZXMiOlsid2tiX2dlbmVyYXRpb24iLCJkYXRhc2V0IiwiYXR0cnMiLCJnZW9tX2NvbCIsIm91dENvbHVtbiIsImNvbnNvbGUiLCJsb2ciLCJnZGYiLCJ0b1drYiIsIndrYl9saXN0IiwiYW5hbHl6ZXJUeXBlIiwiZGlzcGxheU5hbWUiLCJmaWVsZElkeCIsImZpZWxkcyIsImxlbmd0aCIsImZvcm1hdCIsImlkIiwibmFtZSIsInR5cGUiLCJkYXRhQ29udGFpbmVyIiwiX3Jvd3MiLCJ0b0FycmF5IiwicHVzaCIsIl9udW1Db2x1bW5zIiwiY2VudHJvaWRfZXh0cmFjdGlvbiIsImNvbF9pZCIsInNpbXBsaWZpY2F0aW9uIiwicG9pbnRTYW1wbGluZyIsIm1lc2hjb2RlX2dlbmVyYWxpemF0aW9uIiwibWVzaGNvZGVfZ2VuZXJhdGlvbiIsImF0dHIiLCJtZXNoY29kZV9hZ2dyZWdhdGlvbiIsImJ1ZmZlcmluZyIsInNwYXRpYWxfbWFza2luZyIsIm9yaURhdGFzZXQiLCJqb2luRGF0YXNldCIsImhvdyIsInJlcGxhY2UiLCJnZW9tQ29sIiwiam9pbkdlb21Db2wiLCJBcnJheSIsImlzQXJyYXkiLCJqb2ludF9nZGYiLCJnZW9tX3VuaW9uIiwidW5pb24iLCJvdXRfZ2RmIiwiY29udGFpbnMiLCJ3aXRoaW4iLCJpbnRlcnNlY3RzIiwibGlzdENvbHVtbnMiLCJzcGF0aWFsX2pvaW4iLCJzcGF0aWFsX21hc2tpbmdfYnlfZ2VvbWV0cnkiLCJkYXRhU2V0Iiwiam9pbnRHZW9tZXRyeSIsImRyb3BfZ2VvbSIsImRmIiwiZHJvcCIsImJhdGNoX3NwYXRpYWxfZ2VvbWV0cnlfZmlsdGVyIiwiZGF0YXNldHMiLCJnZW9tZXRyeUZpbHRlciIsIm9kZGF0YUlEIiwiZ3BzZGF0YUlEIiwicG9pZGF0YUlEIiwiZmlsdGVyX2dlb20iLCJ0dXJmIiwiZmVhdHVyZSIsIkdFT01FVFJZX1JBTkdFIiwiZ2VvbWV0cnkiLCJnZW9tX2NvbHMiLCJEQVRBU0VUX0NPTFVNTlMiLCJjb25jYXQiLCJyZWR1Y2UiLCJkcyIsImNvbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFvQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBeEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBU08sU0FBU0EsY0FBVCxDQUF3QkMsT0FBeEIsRUFBaUNDLEtBQWpDLEVBQXVDO0FBQUEsTUFDcENDLFFBRG9DLEdBQ2RELEtBRGMsQ0FDcENDLFFBRG9DO0FBQUEsTUFDM0JDLFNBRDJCLEdBQ2RGLEtBRGMsQ0FDM0JFLFNBRDJCO0FBRTFDQyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxvQkFBWjtBQUNBLE1BQU1DLEdBQUcsR0FBRyw0REFBZ0NOLE9BQWhDLEVBQXdDRSxRQUF4QyxDQUFaO0FBQ0FJLEVBQUFBLEdBQUcsQ0FBQ0MsS0FBSjtBQUNBLE1BQU1DLFFBQVEsR0FBRztBQUFDQyxJQUFBQSxZQUFZLEVBQUUsUUFBZjtBQUF3QkMsSUFBQUEsV0FBVyxFQUFFUCxTQUFyQztBQUErQ1EsSUFBQUEsUUFBUSxFQUFFWCxPQUFPLENBQUNZLE1BQVIsQ0FBZUMsTUFBeEU7QUFBZ0ZDLElBQUFBLE1BQU0sRUFBRSxFQUF4RjtBQUE0RkMsSUFBQUEsRUFBRSxFQUFFWixTQUFoRztBQUEyR2EsSUFBQUEsSUFBSSxFQUFFYixTQUFqSDtBQUE0SGMsSUFBQUEsSUFBSSxFQUFFO0FBQWxJLEdBQWpCO0FBQ0FqQixFQUFBQSxPQUFPLENBQUNrQixhQUFSLENBQXNCQyxLQUF0QixHQUE4QmIsR0FBRyxDQUFDYyxPQUFKLEVBQTlCO0FBQ0FwQixFQUFBQSxPQUFPLENBQUNZLE1BQVIsQ0FBZVMsSUFBZixDQUFvQmIsUUFBcEI7QUFDQVIsRUFBQUEsT0FB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LFVBQUNDLEVBQUQsRUFBSUMsR0FBSjtBQUFBLGFBQVd0QiwyQkFBMkIsQ0FBQ3FCLEVBQUQsRUFBSUMsR0FBSixFQUFRVixXQUFSLEVBQW9CLFVBQXBCLEVBQStCdkIsS0FBSyxDQUFDQyxPQUFOLENBQWNnQyxHQUFkLENBQS9CLENBQXRDO0FBQUEsS0FBakIsRUFBMEdmLFFBQVEsQ0FBQ0csU0FBRCxDQUFsSCxDQUFwQixDQUF0QjtBQUNEOztBQUVELE1BQUdDLFNBQUgsRUFBYTtBQUNYLFFBQU1NLFdBQVMsR0FBR0MsaUNBQWdCLFNBQWhCLEVBQTJCLEtBQTNCLENBQWxCO0FBQ0FYLElBQUFBLFFBQVEsQ0FBQ0ksU0FBRCxDQUFSLEdBQXNCLGdEQUFvQk0sV0FBUyxDQUFDRyxNQUFWLENBQWlCLFVBQUNDLEVBQUQsRUFBSUMsR0FBSjtBQUFBLGFBQVd0QiwyQkFBMkIsQ0FBQ3FCLEVBQUQsRUFBSUMsR0FBSixFQUFRVixXQUFSLEVBQW9CLFVBQXBCLEVBQStCdkIsS0FBSyxDQUFDQyxPQUFOLENBQWNnQyxHQUFkLENBQS9CLENBQXRDO0FBQUEsS0FBakIsRUFBMEdmLFFBQVEsQ0FBQ0ksU0FBRCxDQUFsSCxDQUFwQixDQUF0QjtBQUNEOztBQUVELFNBQU9KLFFBQVA7QUFFRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAyMiBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCB7Z2VuZXJhdGVfZGF0YWZyYW1lX2Zyb21fZGF0YXNldCwgcmVzZXRfaW5kZXhfZGF0YXNldH0gZnJvbSAnLi4vZGF0YXNldC1leHRlbnNpb24tdXRpbHMnO1xuaW1wb3J0IHthZGRUYWJsZUNvbHVtbn0gZnJvbSAnLi4vLi4vYWN0aW9ucy92aXMtc3RhdGUtYWN0aW9ucyc7XG5pbXBvcnQge3Byb2Nlc3NDc3ZEYXRhfSBmcm9tICcuLi8uLi9wcm9jZXNzb3JzL2RhdGEtcHJvY2Vzc29yJztcbmltcG9ydCB7REFUQVNFVF9DT0xVTU5TLCBHRU9NRVRSWV9SQU5HRX0gZnJvbSAnLi4vLi4vY29uc3RhbnRzL2RlZmF1bHQtc2V0dGluZ3MnO1xuaW1wb3J0ICogYXMgdHVyZiBmcm9tICdAdHVyZi90dXJmJztcblxuXG5leHBvcnQgZnVuY3Rpb24gd2tiX2dlbmVyYXRpb24oZGF0YXNldCwgYXR0cnMpe1xuICDjgIBjb25zdCB7Z2VvbV9jb2wsb3V0Q29sdW1ufSA9IGF0dHJzXG4gICAgY29uc29sZS5sb2coJ3J1biB3a2IgZ2VuZXJhdGluZycpXG4gICAgY29uc3QgZ2RmID0gZ2VuZXJhdGVfZGF0YWZyYW1lX2Zyb21fZGF0YXNldChkYXRhc2V0LGdlb21fY29sKVxuICAgIGdkZi50b1drYigpXG4gICAgY29uc3Qgd2tiX2xpc3QgPSB7YW5hbHl6ZXJUeXBlOiBcIlNUUklOR1wiLGRpc3BsYXlOYW1lOiBvdXRDb2x1bW4sZmllbGRJZHg6IGRhdGFzZXQuZmllbGRzLmxlbmd0aCwgZm9ybWF0OiBcIlwiLCBpZDogb3V0Q29sdW1uLCBuYW1lOiBvdXRDb2x1bW4sIHR5cGU6IFwic3RyaW5nXCJ9XG4gICAgZGF0YXNldC5kYXRhQ29udGFpbmVyLl9yb3dzID0gZ2RmLnRvQXJyYXkoKVxuICAgIGRhdGFzZXQuZmllbGRzLnB1c2god2tiX2xpc3QpXG4gICAgZGF0YXNldC5kYXRhQ29udGFpbmVyLl9udW1Db2x1bW5zID0gZGF0YXNldC5kYXRhQ29udGFpbmVyLl9udW1Db2x1bW5zKzFcbiAgICByZXR1cm4gZGF0YXNldFxufVxuXG5leHBvcnQgZnVuY3Rpb24gY2VudHJvaWRfZXh0cmFjdGlvbihkYXRhc2V0LGNvbF9pZCl7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNpbXBsaWZpY2F0aW9uKCl7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwb2ludFNhbXBsaW5nKCl7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lc2hjb2RlX2dlbmVyYWxpemF0aW9uKCl7XG4gIGFkZFRhYmxlQ29sdW1uKClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lc2hjb2RlX2dlbmVyYXRpb24oZGF0YXNldCxhdHRyLGdlb21fY29sPSdfZ2VvanNvbicpe1xuICBjb25zdCBnZGYgPSBnZW5lcmF0ZV9kYXRhZnJhbWVfZnJvbV9kYXRhc2V0KGRhdGFzZXQsZ2VvbV9jb2wpO1xufVxuXG4vL+mavuW6pu+8mumcgOimgea3u+WKoGxheWVyLOWmguS9lei/m+ihjOabtOaWsO+8n1xuZXhwb3J0IGZ1bmN0aW9uIG1lc2hjb2RlX2FnZ3JlZ2F0aW9uKGRhdGFzZXQsYXR0cixnZW9tX2NvbD0nX2dlb2pzb24nKXtcblxufVxuXG4vL3RvZG86IGJ1ZmZlcmluZyBzcGF0aWFsIGRhdGE7XG5leHBvcnQgZnVuY3Rpb24gYnVmZmVyaW5nKGRhdGFzZXQsYXR0cixnZW9tX2NvbD0nX2dlb2pzb24nKXtcblxufVxuXG5cblxuXG4vL3RoZXJlIGFyZSBzZXZlcmFsIGZ1bmN0aW9uc1xuZXhwb3J0IGZ1bmN0aW9uIHNwYXRpYWxfbWFza2luZyhvcmlEYXRhc2V0LGpvaW5EYXRhc2V0LGhvdyxyZXBsYWNlLGdlb21Db2wsam9pbkdlb21Db2wpe1xuICBjb25zb2xlLmxvZygnc3BhdGlhbCBtYXNraW5nJyk7XG4gIGNvbnN0IGdkZiA9IEFycmF5LmlzQXJyYXkoZ2VvbUNvbCk/Z2VuZXJhdGVfZGF0YWZyYW1lX2Zyb21fZGF0YXNldChvcmlEYXRhc2V0LG51bGwsZ2VvbUNvbFswXSxnZW9tQ29sWzFdKTpnZW5lcmF0ZV9kYXRhZnJhbWVfZnJvbV9kYXRhc2V0KG9yaURhdGFzZXQsZ2VvbUNvbCk7XG4gIGNvbnN0IGpvaW50X2dkZiA9IGdlbmVyYXRlX2RhdGFmcmFtZV9mcm9tX2RhdGFzZXQoam9pbkRhdGFzZXQsam9pbkdlb21Db2wpXG4gIGNvbnN0IGdlb21fdW5pb24gPSBqb2ludF9nZGYudW5pb24oKVxuICBjb25zdCBvdXRfZ2RmID0gaG93ID09PSAnY29udGFpbic/Z2RmLmNvbnRhaW5zKGdlb21fdW5pb24pOignd2l0aGluJz9nZGYud2l0aGluKGdlb21fdW5pb24pOignaW50ZXJzZWN0Jz9nZGYuaW50ZXJzZWN0cyhnZW9tX3VuaW9uKTpudWxsKSlcbiAgcmV0dXJuIHByb2Nlc3NDc3ZEYXRhKG91dF9nZGYudG9BcnJheSgpLCBvdXRfZ2RmLmxpc3RDb2x1bW5zKCkpXG59XG5cbi8vdG9kbzogc3BhdGlhbCBqb2luXG5leHBvcnQgZnVuY3Rpb24gc3BhdGlhbF9qb2luKG9yaURhdGFzZXQsam9pbkRhdGFzZXQsaG93LHJlcGxhY2UsZ2VvbUNvbCxqb2luR2VvbUNvbCl7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNwYXRpYWxfbWFza2luZ19ieV9nZW9tZXRyeShkYXRhU2V0LGdlb21Db2wsam9pbnRHZW9tZXRyeSxob3c9J2NvbnRhaW5zJyxkcm9wX2dlb209ZmFsc2Upe1xuICBjb25zdCBnZGYgPSBnZW5lcmF0ZV9kYXRhZnJhbWVfZnJvbV9kYXRhc2V0KGRhdGFTZXQsZ2VvbUNvbClcbiAgY29uc3Qgb3V0X2dkZiA9IGhvdyA9PT0gJ2NvbnRhaW4nP2dkZi5jb250YWlucyhqb2ludEdlb21ldHJ5KTooJ3dpdGhpbic/Z2RmLndpdGhpbihqb2ludEdlb21ldHJ5KTooJ2ludGVyc2VjdCc/Z2RmLmludGVyc2VjdHMoam9pbnRHZW9tZXRyeSk6bnVsbCkpXG4gIGRhdGFTZXQuZGF0YUNvbnRhaW5lci5fcm93cyA9IGRyb3BfZ2VvbT9vdXRfZ2RmLmRmLmRyb3Aob3V0X2dkZi5nZW9tX2NvbCkudG9BcnJheSgpOm91dF9nZGYuZGYudG9BcnJheSgpXG4gIHJldHVybiBkYXRhU2V0XG59XG5cblxuLy8gZXhwb3J0IGZ1bmN0aW9uIHNwYXRpYWxfam9pblxuXG5leHBvcnQgZnVuY3Rpb24gYmF0Y2hfc3BhdGlhbF9nZW9tZXRyeV9maWx0ZXIoZGF0YXNldHMsIGdlb21ldHJ5RmlsdGVyLCBvZGRhdGFJRCwgZ3BzZGF0YUlELCBwb2lkYXRhSUQpe1xuICBjb25zb2xlLmxvZygnYmF0Y2ggZ2VvbWV0cnkgZmlsdGVyJylcbiAgY29uc3QgZmlsdGVyX2dlb20gPSB0dXJmLmZlYXR1cmUoR0VPTUVUUllfUkFOR0VbZ2VvbWV0cnlGaWx0ZXJdLmdlb21ldHJ5KVxuXG4gIGlmKG9kZGF0YUlEKXtcbiAgICBjb25zdCBnZW9tX2NvbHMgPSBEQVRBU0VUX0NPTFVNTlNbJ29kZGF0YSddWydncHMnXS5jb25jYXQoREFUQVNFVF9DT0xVTU5TWydvZGRhdGEnXVsnZ2VvbWV0cnknXSlcbiAgICBkYXRhc2V0c1tvZGRhdGFJRF0gPSByZXNldF9pbmRleF9kYXRhc2V0KGdlb21fY29scy5yZWR1Y2UoKGRzLGNvbCk9PiBzcGF0aWFsX21hc2tpbmdfYnlfZ2VvbWV0cnkoZHMsY29sLGZpbHRlcl9nZW9tLCdjb250YWlucycsQXJyYXkuaXNBcnJheShjb2wpKSxkYXRhc2V0c1tvZGRhdGFJRF0pKVxuICB9XG5cbiAgaWYoZ3BzZGF0YUlEKXtcbiAgICBjb25zdCBnZW9tX2NvbHMgPSBEQVRBU0VUX0NPTFVNTlNbJ2dwc2RhdGEnXVsnZ3BzJ11cbiAgICBkYXRhc2V0c1tncHNkYXRhSURdID0gcmVzZXRfaW5kZXhfZGF0YXNldChnZW9tX2NvbHMucmVkdWNlKChkcyxjb2wpPT4gc3BhdGlhbF9tYXNraW5nX2J5X2dlb21ldHJ5KGRzLGNvbCxmaWx0ZXJfZ2VvbSwnY29udGFpbnMnLEFycmF5LmlzQXJyYXkoY29sKSksZGF0YXNldHNbZ3BzZGF0YUlEXSkpXG4gIH1cblxuICBpZihwb2lkYXRhSUQpe1xuICAgIGNvbnN0IGdlb21fY29scyA9IERBVEFTRVRfQ09MVU1OU1sncG9pZGF0YSddWydncHMnXVxuICAgIGRhdGFzZXRzW3BvaWRhdGFJRF0gPSByZXNldF9pbmRleF9kYXRhc2V0KGdlb21fY29scy5yZWR1Y2UoKGRzLGNvbCk9PiBzcGF0aWFsX21hc2tpbmdfYnlfZ2VvbWV0cnkoZHMsY29sLGZpbHRlcl9nZW9tLCdjb250YWlucycsQXJyYXkuaXNBcnJheShjb2wpKSxkYXRhc2V0c1twb2lkYXRhSURdKSlcbiAgfVxuXG4gIHJldHVybiBkYXRhc2V0c1xuXG59XG5cblxuXG5cblxuXG4iXX0=