"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.google_place_id_query = google_place_id_query;
exports.geocoding_api_query = geocoding_api_query;
exports.server_place_id_query = server_place_id_query;
exports.server_poi_type_query = server_poi_type_query;
exports.server_geocoding_query = server_geocoding_query;
exports.google_reverse_geocoding_query = google_reverse_geocoding_query;
exports.AutoTotalAPIQueryTasks = AutoTotalAPIQueryTasks;
exports.getAPIQueryTasks = getAPIQueryTasks;
exports.getAPIQueryListTasks = getAPIQueryListTasks;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _datasetExtensionUtils = require("../dataset-extension-utils");

var _tasks = _interopRequireDefault(require("react-palm/tasks"));

var _tasks2 = require("../../tasks/tasks");

var _defaultSettings = require("../../constants/default-settings");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

// import {addTableColumn} from '../../actions';
// import {addTableColumn} from '../../actions/vis-state-actions';
//deprecated
function google_place_id_query(dataset, attrs) {
  console.log('google query');
  var col = attrs.col,
      key = attrs.key,
      id = attrs.id,
      precision = attrs.precision,
      visStateAction = attrs.visStateAction,
      replace = attrs.replace;
  var paras = {
    fields: 'name,type,formatted_address,address_components',
    language: 'ja',
    key: key
  };
  var api_template = 'https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/place/details/json?';
  var df = (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(dataset, null);
  df = df.map(function (x) {
    return x.set('url', api_template + new URLSearchParams(_objectSpread(_objectSpread({}, paras), {
      atype: 'addgen',
      place_id: x.get(col)
    })).toString());
  });
  return getAPIQueryTasks(id, df.select('url').toArray().map(function (x) {
    return x[0];
  }), visStateAction, 'address_example', 'address', replace);
}

function geocoding_api_query(dataset, attrs) {
  console.log('geocoding query');
  var col = attrs.col,
      key = attrs.key,
      dataId = attrs.dataId,
      visStateAction = attrs.visStateAction,
      precision = attrs.precision,
      outColumn = attrs.outColumn,
      replace = attrs.replace;
  var paras = {
    atype: 'geocoding',
    engine: 'google',
    lang: 'ja',
    token: key
  };
  var api_template = 'http://localhost:8000/api/geocoding?';
  var df = (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(dataset, null);
  df = df.map(function (x) {
    return x.set('url', api_template + new URLSearchParams(_objectSpread(_objectSpread({}, paras), {
      address: x.get(col)
    })).toString());
  });
  return getAPIQueryTasks(dataId, df.select('url').toArray().map(function (x) {
    return x[0];
  }), visStateAction, outColumn, 'latlng', replace, 'real');
}

function server_place_id_query(dataset, attrs) {
  console.log('google query');
  var col = attrs.col,
      key = attrs.key,
      dataId = attrs.dataId,
      visStateAction = attrs.visStateAction,
      precision = attrs.precision,
      outColumn = attrs.outColumn,
      replace = attrs.replace;
  var paras = {
    atype: 'addgen',
    engine: 'google',
    lang: 'ja',
    token: key,
    precision: _defaultSettings.ADDRESS_LEVEL_DICT[precision]
  };
  var api_template = 'http://localhost:8000/api/queryid?';
  var df = (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(dataset, null);
  df = df.map(function (x) {
    return x.set('url', api_template + new URLSearchParams(_objectSpread(_objectSpread({}, paras), {
      place_id: x.get(col)
    })).toString());
  });
  return getAPIQueryTasks(dataId, df.select('url').toArray().map(function (x) {
    return x[0];
  }), visStateAction, outColumn, 'address', replace);
}

function server_poi_type_query(dataset, attrs) {
  // console.log('google query poi')
  var col = attrs.col,
      key = attrs.key,
      dataId = attrs.dataId,
      visStateAction = attrs.visStateAction,
      outColumn = attrs.outColumn,
      replace = attrs.replace;
  var paras = {
    atype: 'poitype',
    engine: 'google',
    lang: 'ja',
    token: key
  };
  var api_template = 'http://localhost:8000/api/queryid?';
  var df = (0, _datasetExtensionUtils.generate_dataframe_from_dataset)(dataset, null);
  df = df.map(function (x) {
    return x.set('url', api_template + new URLSearchParams(_objectSpread(_objectSpread({}, paras), {
      place_id: x.get(col)
    })).toString());
  });
  return getAPIQueryTasks(dataId, df.select('url').toArray().map(function (x) {
    return x[0];
  }), visStateAction, outColumn, 'poitype', replace);
}

function server_geocoding_query(dataset, attrs) {}

function google_reverse_geocoding_query(dataset, place_id_col) {}

function AutoTotalAPIQueryTasks(datasets, visStateActions) {}

function getAPIQueryTasks(dataId, query_list, visStateActions) {
  var query_col = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 'api_result';
  var return_key = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : 'address';
  var replace = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : false;
  var data_type = arguments.length > 6 && arguments[6] !== undefined ? arguments[6] : 'string';
  console.log('get api query tasks' + dataId);
  return [_tasks["default"].all(query_list.map(_tasks2.LOAD_API_TASK)).bimap(function (results) {
    console.log('successfully get api result');
    visStateActions.visStateAction.addTableColumn(dataId, query_col, data_type, results.map(function (x) {
      return x[return_key];
    }, replace));
    visStateActions.visStateAction.removeProcessor(true);
  }, function (error) {
    console.log(error);
    visStateActions.visStateAction.removeProcessor(false);
    return null;
  })];
}

function getAPIQueryListTasks(query_list, visStateActions, datasets) {
  return [_tasks["default"].all(query_list.map(_tasks2.LOAD_API_TASK)).bimap(function (results) {
    console.log('successfully get api result');
    visStateActions.visStateAction.GMTModifyTableColumn(results, datasets); // visStateActions.visStateAction.removeProcessor(true)
  }, function (error) {
    console.log(error); // visStateActions.visStateAction.removeProcessor(false)

    return null;
  })];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9wcm9jZXNzb3ItdXRpbHMvZ29vZ2xlYXBpLXByb2Nlc3Nvci11dGlscy5qcyJdLCJuYW1lcyI6WyJnb29nbGVfcGxhY2VfaWRfcXVlcnkiLCJkYXRhc2V0IiwiYXR0cnMiLCJjb25zb2xlIiwibG9nIiwiY29sIiwia2V5IiwiaWQiLCJwcmVjaXNpb24iLCJ2aXNTdGF0ZUFjdGlvbiIsInJlcGxhY2UiLCJwYXJhcyIsImZpZWxkcyIsImxhbmd1YWdlIiwiYXBpX3RlbXBsYXRlIiwiZGYiLCJtYXAiLCJ4Iiwic2V0IiwiVVJMU2VhcmNoUGFyYW1zIiwiYXR5cGUiLCJwbGFjZV9pZCIsImdldCIsInRvU3RyaW5nIiwiZ2V0QVBJUXVlcnlUYXNrcyIsInNlbGVjdCIsInRvQXJyYXkiLCJnZW9jb2RpbmdfYXBpX3F1ZXJ5IiwiZGF0YUlkIiwib3V0Q29sdW1uIiwiZW5naW5lIiwibGFuZyIsInRva2VuIiwiYWRkcmVzcyIsInNlcnZlcl9wbGFjZV9pZF9xdWVyeSIsIkFERFJFU1NfTEVWRUxfRElDVCIsInNlcnZlcl9wb2lfdHlwZV9xdWVyeSIsInNlcnZlcl9nZW9jb2RpbmdfcXVlcnkiLCJnb29nbGVfcmV2ZXJzZV9nZW9jb2RpbmdfcXVlcnkiLCJwbGFjZV9pZF9jb2wiLCJBdXRvVG90YWxBUElRdWVyeVRhc2tzIiwiZGF0YXNldHMiLCJ2aXNTdGF0ZUFjdGlvbnMiLCJxdWVyeV9saXN0IiwicXVlcnlfY29sIiwicmV0dXJuX2tleSIsImRhdGFfdHlwZSIsIlRhc2siLCJhbGwiLCJMT0FEX0FQSV9UQVNLIiwiYmltYXAiLCJyZXN1bHRzIiwiYWRkVGFibGVDb2x1bW4iLCJyZW1vdmVQcm9jZXNzb3IiLCJlcnJvciIsImdldEFQSVF1ZXJ5TGlzdFRhc2tzIiwiR01UTW9kaWZ5VGFibGVDb2x1bW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFvQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUNBO0FBQ0E7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Q0FBK0IrQyxvQkFBL0IsQ0FBb0RMLE9BQXBELEVBQTREVixRQUE1RCxFQUZTLENBR1Q7QUFFRCxHQVJLLEVBU04sVUFBQWEsS0FBSyxFQUFJO0FBQ1BuRCxJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWWtELEtBQVosRUFETyxDQUVQOztBQUNBLFdBQU8sSUFBUDtBQUNELEdBYkssQ0FBRCxDQUFQO0FBZUQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMjIgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQge2dlbmVyYXRlX2RhdGFmcmFtZV9mcm9tX2RhdGFzZXR9IGZyb20gJy4uL2RhdGFzZXQtZXh0ZW5zaW9uLXV0aWxzJztcbmltcG9ydCBUYXNrIGZyb20gJ3JlYWN0LXBhbG0vdGFza3MnO1xuaW1wb3J0IHtMT0FEX0FQSV9UQVNLfSBmcm9tICcuLi8uLi90YXNrcy90YXNrcyc7XG5pbXBvcnQge0FERFJFU1NfTEVWRUxfRElDVH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzL2RlZmF1bHQtc2V0dGluZ3MnO1xuLy8gaW1wb3J0IHthZGRUYWJsZUNvbHVtbn0gZnJvbSAnLi4vLi4vYWN0aW9ucyc7XG4vLyBpbXBvcnQge2FkZFRhYmxlQ29sdW1ufSBmcm9tICcuLi8uLi9hY3Rpb25zL3Zpcy1zdGF0ZS1hY3Rpb25zJztcblxuLy9kZXByZWNhdGVkXG5leHBvcnQgZnVuY3Rpb24gZ29vZ2xlX3BsYWNlX2lkX3F1ZXJ5KGRhdGFzZXQsYXR0cnMpe1xuICBjb25zb2xlLmxvZygnZ29vZ2xlIHF1ZXJ5JylcbiAgY29uc3Qge2NvbCxrZXksaWQscHJlY2lzaW9uLHZpc1N0YXRlQWN0aW9uLHJlcGxhY2V9ID0gYXR0cnNcbiAgY29uc3QgcGFyYXMgPSB7XG4gICAgZmllbGRzOiduYW1lLHR5cGUsZm9ybWF0dGVkX2FkZHJlc3MsYWRkcmVzc19jb21wb25lbnRzJyxcbiAgICBsYW5ndWFnZTonamEnLFxuICAgIGtleTprZXl9XG4gIGxldCBhcGlfdGVtcGxhdGUgPSAnaHR0cHM6Ly9jb3JzLWFueXdoZXJlLmhlcm9rdWFwcC5jb20vaHR0cHM6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL3BsYWNlL2RldGFpbHMvanNvbj8nXG4gIGxldCBkZiA9IGdlbmVyYXRlX2RhdGFmcmFtZV9mcm9tX2RhdGFzZXQoZGF0YXNldCxudWxsKVxuICBkZiA9IGRmLm1hcCgoeCk9Pnguc2V0KCd1cmwnLGFwaV90ZW1wbGF0ZSArIG5ldyBVUkxTZWFyY2hQYXJhbXMoey4uLnBhcmFzLC4uLnthdHlwZTonYWRkZ2VuJyxwbGFjZV9pZDp4LmdldChjb2wpfX0pLnRvU3RyaW5nKCkpKVxuICByZXR1cm4gZ2V0QVBJUXVlcnlUYXNrcyhpZCxkZi5zZWxlY3QoJ3VybCcpLnRvQXJyYXkoKS5tYXAoKHgpPT54WzBdKSx2aXNTdGF0ZUFjdGlvbiwnYWRkcmVzc19leGFtcGxlJywnYWRkcmVzcycscmVwbGFjZSlcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZ2VvY29kaW5nX2FwaV9xdWVyeShkYXRhc2V0LGF0dHJzKXtcbiAgY29uc29sZS5sb2coJ2dlb2NvZGluZyBxdWVyeScpXG4gIGNvbnN0IHtjb2wsa2V5LGRhdGFJZCx2aXNTdGF0ZUFjdGlvbixwcmVjaXNpb24sb3V0Q29sdW1uLHJlcGxhY2V9ID0gYXR0cnNcbiAgY29uc3QgcGFyYXMgPSB7XG4gICAgYXR5cGU6J2dlb2NvZGluZycsXG4gICAgZW5naW5lOidnb29nbGUnLFxuICAgIGxhbmc6J2phJyxcbiAgICB0b2tlbjprZXl9XG4gIGxldCBhcGlfdGVtcGxhdGUgPSAnaHR0cDovL2xvY2FsaG9zdDo4MDAwL2FwaS9nZW9jb2Rpbmc/J1xuICBsZXQgZGYgPSBnZW5lcmF0ZV9kYXRhZnJhbWVfZnJvbV9kYXRhc2V0KGRhdGFzZXQsbnVsbClcbiAgZGYgPSBkZi5tYXAoKHgpPT54LnNldCgndXJsJyxhcGlfdGVtcGxhdGUgKyBuZXcgVVJMU2VhcmNoUGFyYW1zKHsuLi5wYXJhcywuLi57YWRkcmVzczp4LmdldChjb2wpfX0pLnRvU3RyaW5nKCkpKVxuICByZXR1cm4gZ2V0QVBJUXVlcnlUYXNrcyhkYXRhSWQsZGYuc2VsZWN0KCd1cmwnKS50b0FycmF5KCkubWFwKCh4KT0+eFswXSksdmlzU3RhdGVBY3Rpb24sb3V0Q29sdW1uLCdsYXRsbmcnLHJlcGxhY2UsJ3JlYWwnKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VydmVyX3BsYWNlX2lkX3F1ZXJ5KGRhdGFzZXQsYXR0cnMpe1xuICBjb25zb2xlLmxvZygnZ29vZ2xlIHF1ZXJ5JylcbiAgY29uc3Qge2NvbCxrZXksZGF0YUlkLHZpc1N0YXRlQWN0aW9uLHByZWNpc2lvbixvdXRDb2x1bW4scmVwbGFjZX0gPSBhdHRyc1xuICBjb25zdCBwYXJhcyA9IHtcbiAgICBhdHlwZTonYWRkZ2VuJyxcbiAgICBlbmdpbmU6J2dvb2dsZScsXG4gICAgbGFuZzonamEnLFxuICAgIHRva2VuOmtleSxcbiAgICBwcmVjaXNpb246QUREUkVTU19MRVZFTF9ESUNUW3ByZWNpc2lvbl19XG4gIGxldCBhcGlfdGVtcGxhdGUgPSAnaHR0cDovL2xvY2FsaG9zdDo4MDAwL2FwaS9xdWVyeWlkPydcbiAgbGV0IGRmID0gZ2VuZXJhdGVfZGF0YWZyYW1lX2Zyb21fZGF0YXNldChkYXRhc2V0LG51bGwpXG4gIGRmID0gZGYubWFwKCh4KT0+eC5zZXQoJ3VybCcsYXBpX3RlbXBsYXRlICsgbmV3IFVSTFNlYXJjaFBhcmFtcyh7Li4ucGFyYXMsLi4ue3BsYWNlX2lkOnguZ2V0KGNvbCl9fSkudG9TdHJpbmcoKSkpXG4gIHJldHVybiBnZXRBUElRdWVyeVRhc2tzKGRhdGFJZCxkZi5zZWxlY3QoJ3VybCcpLnRvQXJyYXkoKS5tYXAoKHgpPT54WzBdKSx2aXNTdGF0ZUFjdGlvbixvdXRDb2x1bW4sJ2FkZHJlc3MnLHJlcGxhY2UpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJ2ZXJfcG9pX3R5cGVfcXVlcnkoZGF0YXNldCxhdHRycyl7XG4gIC8vIGNvbnNvbGUubG9nKCdnb29nbGUgcXVlcnkgcG9pJylcbiAgY29uc3Qge2NvbCxrZXksZGF0YUlkLHZpc1N0YXRlQWN0aW9uLG91dENvbHVtbixyZXBsYWNlfSA9IGF0dHJzXG4gIGNvbnN0IHBhcmFzID0ge1xuICAgIGF0eXBlOidwb2l0eXBlJyxcbiAgICBlbmdpbmU6J2dvb2dsZScsXG4gICAgbGFuZzonamEnLFxuICAgIHRva2VuOmtleX1cbiAgbGV0IGFwaV90ZW1wbGF0ZSA9ICdodHRwOi8vbG9jYWxob3N0OjgwMDAvYXBpL3F1ZXJ5aWQ/J1xuICBsZXQgZGYgPSBnZW5lcmF0ZV9kYXRhZnJhbWVfZnJvbV9kYXRhc2V0KGRhdGFzZXQsbnVsbClcbiAgZGYgPSBkZi5tYXAoKHgpPT54LnNldCgndXJsJyxhcGlfdGVtcGxhdGUgKyBuZXcgVVJMU2VhcmNoUGFyYW1zKHsuLi5wYXJhcywuLi57cGxhY2VfaWQ6eC5nZXQoY29sKX19KS50b1N0cmluZygpKSlcbiAgcmV0dXJuIGdldEFQSVF1ZXJ5VGFza3MoZGF0YUlkLGRmLnNlbGVjdCgndXJsJykudG9BcnJheSgpLm1hcCgoeCk9PnhbMF0pLHZpc1N0YXRlQWN0aW9uLG91dENvbHVtbiwncG9pdHlwZScscmVwbGFjZSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcnZlcl9nZW9jb2RpbmdfcXVlcnkoZGF0YXNldCxhdHRycyl7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdvb2dsZV9yZXZlcnNlX2dlb2NvZGluZ19xdWVyeShkYXRhc2V0LHBsYWNlX2lkX2NvbCl7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIEF1dG9Ub3RhbEFQSVF1ZXJ5VGFza3MoZGF0YXNldHMsdmlzU3RhdGVBY3Rpb25zKXtcblxuXG5cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QVBJUXVlcnlUYXNrcyhkYXRhSWQscXVlcnlfbGlzdCx2aXNTdGF0ZUFjdGlvbnMscXVlcnlfY29sPSdhcGlfcmVzdWx0JyxyZXR1cm5fa2V5PSdhZGRyZXNzJyxyZXBsYWNlPWZhbHNlLGRhdGFfdHlwZT0nc3RyaW5nJyl7XG4gIGNvbnNvbGUubG9nKCdnZXQgYXBpIHF1ZXJ5IHRhc2tzJyArIGRhdGFJZClcbiAgcmV0dXJuIFtUYXNrLmFsbChcbiAgICBxdWVyeV9saXN0Lm1hcChMT0FEX0FQSV9UQVNLKVxuICApLmJpbWFwKFxuICAgIHJlc3VsdHMgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ3N1Y2Nlc3NmdWxseSBnZXQgYXBpIHJlc3VsdCcpXG4gICAgICB2aXNTdGF0ZUFjdGlvbnMudmlzU3RhdGVBY3Rpb24uYWRkVGFibGVDb2x1bW4oZGF0YUlkLHF1ZXJ5X2NvbCxkYXRhX3R5cGUscmVzdWx0cy5tYXAoKHgpPT54W3JldHVybl9rZXldLHJlcGxhY2UpKVxuICAgICAgdmlzU3RhdGVBY3Rpb25zLnZpc1N0YXRlQWN0aW9uLnJlbW92ZVByb2Nlc3Nvcih0cnVlKVxuXG4gICAgfSxcbiAgICBlcnJvciA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhlcnJvcilcbiAgICAgIHZpc1N0YXRlQWN0aW9ucy52aXNTdGF0ZUFjdGlvbi5yZW1vdmVQcm9jZXNzb3IoZmFsc2UpXG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cbiAgKV1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEFQSVF1ZXJ5TGlzdFRhc2tzKHF1ZXJ5X2xpc3QsdmlzU3RhdGVBY3Rpb25zLGRhdGFzZXRzKXtcbiAgcmV0dXJuIFtUYXNrLmFsbChcbiAgICBxdWVyeV9saXN0Lm1hcChMT0FEX0FQSV9UQVNLKVxuICApLmJpbWFwKFxuICAgIHJlc3VsdHMgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ3N1Y2Nlc3NmdWxseSBnZXQgYXBpIHJlc3VsdCcpXG4gICAgICB2aXNTdGF0ZUFjdGlvbnMudmlzU3RhdGVBY3Rpb24uR01UTW9kaWZ5VGFibGVDb2x1bW4ocmVzdWx0cyxkYXRhc2V0cylcbiAgICAgIC8vIHZpc1N0YXRlQWN0aW9ucy52aXNTdGF0ZUFjdGlvbi5yZW1vdmVQcm9jZXNzb3IodHJ1ZSlcblxuICAgIH0sXG4gICAgZXJyb3IgPT4ge1xuICAgICAgY29uc29sZS5sb2coZXJyb3IpXG4gICAgICAvLyB2aXNTdGF0ZUFjdGlvbnMudmlzU3RhdGVBY3Rpb24ucmVtb3ZlUHJvY2Vzc29yKGZhbHNlKVxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG4gICldXG59XG4iXX0=