"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.time_flooring = time_flooring;
exports.date_filter_process = date_filter_process;
exports.time_filter_process = time_filter_process;
exports.batch_temporal_filter_process = batch_temporal_filter_process;

var _datasetExtensionUtils = require("../dataset-extension-utils");

var _dateUtils = require("../date-utils");

var _lodash = _interopRequireDefault(require("lodash"));

// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
//no need to change data format
function time_flooring(dataset, attrs) {
  var col = attrs.col,
      minute_unit = attrs.minute_unit,
      outColumn = attrs.outColumn,
      replace = attrs.replace;
  var col_info = dataset.fields.filter(function (x) {
    return col === x.name;
  });

  if (col_info.length === 0 || minute_unit == null) {
    return dataset;
  } else {
    var column_spec = col_info[0];
    var format = column_spec.format;

    if (!outColumn) {
      dataset.dataContainer._rows = dataset.dataContainer._rows.map(function (x) {
        x[column_spec.fieldIdx] = (0, _dateUtils.floorTime)(x[column_spec.fieldIdx], format, minute_unit);
        return x;
      });
    } else {
      dataset = (0, _datasetExtensionUtils.add_dataset_column)(dataset, outColumn, 'float', dataset.dataContainer._rows.map(function (x) {
        return (0, _dateUtils.floorTime)(x[column_spec.fieldIdx], format, minute_unit);
      }), replace);
    }
  }

  return dataset;
} //only include those date only in the selected area:


function date_filter_process(dataset, col, dow, daterange, removeHolidayFlag) {
  console.log('run date filter process');
  var col_info = dataset.fields.filter(function (x) {
    return col === x.name;
  });

  if (col_info.length === 0) {
    return dataset;
  }

  if (Array.isArray(col)) {
    var column_spec = col_info[0];
    dataset.dataContainer._rows = dataset.dataContainer._rows.filter(function (x) {
      (0, _dateUtils.dateFilter)(x[column_spec.fieldsIdx], dow, daterange, removeHolidayFlag);
    });
  }

  return dataset;
}

function time_filter_process(dataset, col, startTime, endTime) {
  var col_target = (!Array.isArray(col) ? [col] : col).map(function (x) {
    col = dataset.fields.filter(function (x) {
      return col === x.name;
    });
    return col.length >= 1 ? col[0] : null;
  });
  dataset.dataContainer._rows = dataset.dataContainer._rows.filter(function (x) {
    return col_target.length === 1 ? (0, _dateUtils.timeFilter)(x[col_target[0].fieldIdx], [startTime, endTime]) : (0, _dateUtils.timeRangeFilter)(x[col_target[0]], x[col_target[1]]);
  });
  return dataset;
} //this will be a batch fu


function batch_temporal_filter_process(dataset, timeCols, dateCols, temporalFilter) {
  // date_cols
  var dow = temporalFilter.dow,
      dateRange = temporalFilter.dateRange,
      removeHoliday = temporalFilter.removeHoliday,
      startTime = temporalFilter.startTime,
      endTime = temporalFilter.endTime,
      floor = temporalFilter.floor;

  var new_dataset = _lodash["default"].cloneDeep(dataset);

  new_dataset = dateCols.reduce(function (ds, col) {
    return date_filter_process(ds, col, dow, dateRange, removeHoliday);
  }, new_dataset);
  new_dataset = timeCols.reduce(function (ds, col) {
    return time_filter_process(ds, col, startTime, endTime);
  }, new_dataset);
  new_dataset = timeCols.reduce(function (ds, col) {
    return time_flooring(ds, {
      col: col,
      minute_unit: floor,
      outColumn: null
    });
  }, new_dataset);
  console.log('finished temporal filter process');
  return new_dataset;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9wcm9jZXNzb3ItdXRpbHMvdGVtcG9yYWwtcHJvY2Vzc29yLXV0aWxzLmpzIl0sIm5hbWVzIjpbInRpbWVfZmxvb3JpbmciLCJkYXRhc2V0IiwiYXR0cnMiLCJjb2wiLCJtaW51dGVfdW5pdCIsIm91dENvbHVtbiIsInJlcGxhY2UiLCJjb2xfaW5mbyIsImZpZWxkcyIsImZpbHRlciIsIngiLCJuYW1lIiwibGVuZ3RoIiwiY29sdW1uX3NwZWMiLCJmb3JtYXQiLCJkYXRhQ29udGFpbmVyIiwiX3Jvd3MiLCJtYXAiLCJmaWVsZElkeCIsImRhdGVfZmlsdGVyX3Byb2Nlc3MiLCJkb3ciLCJkYXRlcmFuZ2UiLCJyZW1vdmVIb2xpZGF5RmxhZyIsImNvbnNvbGUiLCJsb2ciLCJBcnJheSIsImlzQXJyYXkiLCJmaWVsZHNJZHgiLCJ0aW1lX2ZpbHRlcl9wcm9jZXNzIiwic3RhcnRUaW1lIiwiZW5kVGltZSIsImNvbF90YXJnZXQiLCJiYXRjaF90ZW1wb3JhbF9maWx0ZXJfcHJvY2VzcyIsInRpbWVDb2xzIiwiZGF0ZUNvbHMiLCJ0ZW1wb3JhbEZpbHRlciIsImRhdGVSYW5nZSIsInJlbW92ZUhvbGlkYXkiLCJmbG9vciIsIm5ld19kYXRhc2V0IiwiXyIsImNsb25lRGVlcCIsInJlZHVjZSIsImRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFxQkE7O0FBQ0E7O0FBQ0E7O0FBdkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUE7QUFPTyxTQUFTQSxhQUFULENBQXVCQyxPQUF2QixFQUFnQ0MsS0FBaEMsRUFBc0M7QUFBQSxNQUVwQ0MsR0FGb0MsR0FFQ0QsS0FGRCxDQUVwQ0MsR0FGb0M7QUFBQSxNQUVoQ0MsV0FGZ0MsR0FFQ0YsS0FGRCxDQUVoQ0UsV0FGZ0M7QUFBQSxNQUVwQkMsU0FGb0IsR0FFQ0gsS0FGRCxDQUVwQkcsU0FGb0I7QUFBQSxNQUVWQyxPQUZVLEdBRUNKLEtBRkQsQ0FFVkksT0FGVTtBQUczQyxNQUFNQyxRQUFRLEdBQUdOLE9BQU8sQ0FBQ08sTUFBUixDQUFlQyxNQUFmLENBQXNCLFVBQUNDLENBQUQ7QUFBQSxXQUFPUCxHQUFHLEtBQUtPLENBQUMsQ0FBQ0MsSUFBakI7QUFBQSxHQUF0QixDQUFqQjs7QUFFQSxNQUFHSixRQUFRLENBQUNLLE1BQVQsS0FBb0IsQ0FBcEIsSUFBeUJSLFdBQVcsSUFBSSxJQUEzQyxFQUFnRDtBQUM5QyxXQUFPSCxPQUFQO0FBQ0QsR0FGRCxNQUdJO0FBRUYsUUFBSVksV0FBVyxHQUFHTixRQUFRLENBQUMsQ0FBRCxDQUExQjtBQUZFLFFBR0tPLE1BSEwsR0FHZUQsV0FIZixDQUdLQyxNQUhMOztBQUlGLFFBQUcsQ0FBQ1QsU0FBSixFQUFjO0FBQ1pKLE1BQUFBLE9BQU8sQ0FBQ2MsYUFBUixDQUFzQkMsS0FBdEIsR0FBOEJmLE9BQU8sQ0FBQ2MsYUFBUixDQUFzQkMsS0FBdEIsQ0FBNEJDLEdBQTVCLENBQWdDLFVBQUNQLENBQUQsRUFBTztBQUNuRUEsUUFBQUEsQ0FBQyxDQUFDRyxXQUFXLENBQUNLLFFBQWIsQ0FBRCxHQUEwQiwwQkFBVVIsQ0FBQyxDQUFDRyxXQUFXLENBQUNLLFFBQWIsQ0FBWCxFQUFrQ0osTUFBbEMsRUFBeUNWLFdBQXpDLENBQTFCO0FBQ0EsZUFBT00sQ0FBUDtBQUNELE9BSDZCLENBQTlCO0FBSUQsS0FMRCxNQU1JO0FBQ0ZULE1BQUFBLE9BQU8sR0FBRywrQ0FBbUJBLE9BQW5CLEVBQTJCSSxTQUEzQixFQUFxQyxPQUFyQyxFQUE2Q0osT0FBTyxDQUFDYyxhQUFSLENBQXNCQyxLQUF0QixDQUE0QkMsR0FBNUIsQ0FBZ0MsVUFBQ1AsQ0FBRDtBQUFBLGVBQU8sMEJBQVVBLENBQUMsQ0FBQ0csV0FBVyxDQUFDSyxRQUFiLENBQVgsRUFBa0NKLE1BQWxDLEVBQXlDVixXQUF6QyxDQUFQO0FBQUEsT0FBaEMsQ0FBN0MsRUFBMklFLE9BQTNJLENBQVY7QUFDRDtBQUNGOztBQUVELFNBQU9MLE9BQVA7QUFFRCxDLENBR0Q7OztBQUNPLFNBQVNrQixtQkFBVCxDQUE2QmxCLE9BQTdCLEVBQXFDRSxHQUFyQyxFQUF5Q2lCLEdBQXpDLEVBQTZDQyxTQUE3QyxFQUF1REMsaUJBQXZELEVBQXlFO0FBQzlFQyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSx5QkFBWjtBQUlBLE1BQU1qQixRQUFRLEdBQUdOLE9BQU8sQ0FBQ08sTUFBUixDQUFlQyxNQUFmLENBQXNCLFVBQUNDLENBQUQ7QUFBQSxXQUFPUCxHQUFHLEtBQUtPLENBQUMsQ0FBQ0MsSUFBakI7QUFBQSxHQUF0QixDQUFqQjs7QUFHQSxNQUFHSixRQUFRLENBQUNLLE1BQVQsS0FBb0IsQ0FBdkIsRUFBeUI7QUFDdkIsV0FBT1gsT0FBUDtBQUNEOztBQUVELE1BQUd3QixLQUFLLENBQUNDLE9BQU4sQ0FBY3ZCLEdBQWQsQ0FBSCxFQUFzQjtBQUNwQixRQUFJVSxXQUFXLEdBQUdOLFFBQVEsQ0FBQyxDQUFELENBQTFCO0FBQ0FOLElBQUFBLE9BQU8sQ0FBQ2MsYUFBUixDQUFzQkMsS0FBdEIsR0FBOEJmLE9BQU8sQ0FBQ2MsYUFBUixDQUFzQkMsS0FBdEIsQ0FBNEJQLE1BQTVCLENBQW1DLFVBQUNDLENBQUQsRUFBTztBQUNwRSxpQ0FBV0EsQ0FBQyxDQUFDRyxXQUFXLENBQUNjLFNBQWIsQ0FBWixFQUFvQ1AsR0FBcEMsRUFBd0NDLFNBQXhDLEVBQWtEQyxpQkFBbEQ7QUFDSCxLQUY2QixDQUE5QjtBQUdEOztBQUVELFNBQU9yQixPQUFQO0FBRUQ7O0FBRU0sU0FBUzJCLG1CQUFULENBQTZCM0IsT0FBN0IsRUFBcUNFLEdBQXJDLEVBQXlDMEIsU0FBekMsRUFBbURDLE9BQW5ELEVBQTJEO0FBRWhFLE1BQU1DLFVBQVUsR0FBRyxDQUFDLENBQUNOLEtBQUssQ0FBQ0MsT0FBTixDQUFjdkIsR0FBZCxDQUFELEdBQW9CLENBQUNBLEdBQUQsQ0FBcEIsR0FBMEJBLEdBQTNCLEVBQWdDYyxHQUFoQyxDQUFvQyxVQUFDUCxDQUFELEVBQUs7QUFDMURQLElBQUFBLEdBQUcsR0FBR0YsT0FBTyxDQUFDTyxNQUFSLENBQWVDLE1BQWYsQ0FBc0IsVUFBQ0MsQ0FBRDtBQUFBLGFBQU9QLEdBQUcsS0FBS08sQ0FBQyxDQUFDQyxJQUFqQjtBQUFBLEtBQXRCLENBQU47QUFDQSxXQUFPUixHQUFHLENBQUNTLE1BQUosSUFBWSxDQUFaLEdBQWNULEdBQUcsQ0FBQyxDQUFELENBQWpCLEdBQXFCLElBQTVCO0FBQ0QsR0FIa0IsQ0FBbkI7QUFLQUYsRUFBQUEsT0FBTyxDQUFDYyxhQUFSLENBQXNCQyxLQUF0QixHQUE4QmYsT0FBTyxDQUFDYyxhQUFSLENBQXNCQyxLQUF0QixDQUE0QlAsTUFBNUIsQ0FBbUMsVUFBQ0MsQ0FBRCxFQUFLO0FBQ3BFLFdBQU9xQixVQUFVLENBQUNuQixNQUFYLEtBQW9CLENBQXBCLEdBQXNCLDJCQUFXRixDQUFDLENBQ3RDcUIsVUFBVSxDQUFDLENBQUQsQ0FBVixDQUFjYixRQUR3QixDQUFaLEVBQ0YsQ0FBQ1csU0FBRCxFQUFXQyxPQUFYLENBREUsQ0FBdEIsR0FDeUMsZ0NBQWdCcEIsQ0FBQyxDQUFDcUIsVUFBVSxDQUFDLENBQUQsQ0FBWCxDQUFqQixFQUFpQ3JCLENBQUMsQ0FBQ3FCLFVBQVUsQ0FBQyxDQUFELENBQVgsQ0FBbEMsQ0FEaEQ7QUFFRCxHQUg2QixDQUE5QjtBQUtBLFNBQU85QixPQUFQO0FBQ0QsQyxDQUtEOzs7QUFDTyxTQUFTK0IsNkJBQVQsQ0FBdUMvQixPQUF2QyxFQUErQ2dDLFFBQS9DLEVBQXdEQyxRQUF4RCxFQUFpRUMsY0FBakUsRUFBZ0Y7QUFDckY7QUFEcUYsTUFFOUVmLEdBRjhFLEdBRXZCZSxjQUZ1QixDQUU5RWYsR0FGOEU7QUFBQSxNQUUxRWdCLFNBRjBFLEdBRXZCRCxjQUZ1QixDQUUxRUMsU0FGMEU7QUFBQSxNQUVoRUMsYUFGZ0UsR0FFdkJGLGNBRnVCLENBRWhFRSxhQUZnRTtBQUFBLE1BRWxEUixTQUZrRCxHQUV2Qk0sY0FGdUIsQ0FFbEROLFNBRmtEO0FBQUEsTUFFeENDLE9BRndDLEdBRXZCSyxjQUZ1QixDQUV4Q0wsT0FGd0M7QUFBQSxNQUVoQ1EsS0FGZ0MsR0FFdkJILGNBRnVCLENBRWhDRyxLQUZnQzs7QUFHckYsTUFBSUMsV0FBVyxHQUFHQyxtQkFBRUMsU0FBRixDQUFZeEMsT0FBWixDQUFsQjs7QUFFQXNDLEVBQUFBLFdBQVcsR0FBR0wsUUFBUSxDQUFDUSxNQUFULENBQWdCLFVBQUNDLEVBQUQsRUFBSXhDLEdBQUo7QUFBQSxXQUFXZ0IsbUJBQW1CLENBQUN3QixFQUFELEVBQUl4QyxHQUFKLEVBQVFpQixHQUFSLEVBQVlnQixTQUFaLEVBQXNCQyxhQUF0QixDQUE5QjtBQUFBLEdBQWhCLEVBQW1GRSxXQUFuRixDQUFkO0FBQ0FBLEVBQUFBLFdBQVcsR0FBR04sUUFBUSxDQUFDUyxNQUFULENBQWdCLFVBQUNDLEVBQUQsRUFBSXhDLEdBQUo7QUFBQSxXQUFVeUIsbUJBQW1CLENBQUNlLEVBQUQsRUFBSXhDLEdBQUosRUFBUTBCLFNBQVIsRUFBa0JDLE9BQWxCLENBQTdCO0FBQUEsR0FBaEIsRUFBd0VTLFdBQXhFLENBQWQ7QUFDQUEsRUFBQUEsV0FBVyxHQUFHTixRQUFRLENBQUNTLE1BQVQsQ0FBZ0IsVUFBQ0MsRUFBRCxFQUFJeEMsR0FBSjtBQUFBLFdBQVVILGFBQWEsQ0FBQzJDLEVBQUQsRUFBSTtBQUFDeEMsTUFBQUEsR0FBRyxFQUFDQSxHQUFMO0FBQVNDLE1BQUFBLFdBQVcsRUFBQ2tDLEtBQXJCO0FBQTJCakMsTUFBQUEsU0FBUyxFQUFDO0FBQXJDLEtBQUosQ0FBdkI7QUFBQSxHQUFoQixFQUF1RmtDLFdBQXZGLENBQWQ7QUFDQWhCLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLGtDQUFaO0FBQ0EsU0FBT2UsV0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDIyIFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuLy9ubyBuZWVkIHRvIGNoYW5nZSBkYXRhIGZvcm1hdFxuaW1wb3J0IHthZGRfZGF0YXNldF9jb2x1bW59IGZyb20gJy4uL2RhdGFzZXQtZXh0ZW5zaW9uLXV0aWxzJztcbmltcG9ydCB7ZGF0ZUZpbHRlciwgZmxvb3JUaW1lLCB0aW1lRmlsdGVyLCB0aW1lUmFuZ2VGaWx0ZXJ9IGZyb20gJy4uL2RhdGUtdXRpbHMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5cbmV4cG9ydCBmdW5jdGlvbiB0aW1lX2Zsb29yaW5nKGRhdGFzZXQsIGF0dHJzKXtcblxuICBjb25zdCB7Y29sLG1pbnV0ZV91bml0LG91dENvbHVtbixyZXBsYWNlfSA9IGF0dHJzXG4gIGNvbnN0IGNvbF9pbmZvID0gZGF0YXNldC5maWVsZHMuZmlsdGVyKCh4KSA9PiBjb2wgPT09IHgubmFtZSk7XG5cbiAgaWYoY29sX2luZm8ubGVuZ3RoID09PSAwIHx8IG1pbnV0ZV91bml0ID09IG51bGwpe1xuICAgIHJldHVybiBkYXRhc2V0XG4gIH1cbiAgZWxzZXtcblxuICAgIGxldCBjb2x1bW5fc3BlYyA9IGNvbF9pbmZvWzBdO1xuICAgIGNvbnN0IHtmb3JtYXR9ID0gY29sdW1uX3NwZWM7XG4gICAgaWYoIW91dENvbHVtbil7XG4gICAgICBkYXRhc2V0LmRhdGFDb250YWluZXIuX3Jvd3MgPSBkYXRhc2V0LmRhdGFDb250YWluZXIuX3Jvd3MubWFwKCh4KSA9PiB7XG4gICAgICAgIHhbY29sdW1uX3NwZWMuZmllbGRJZHhdID0gZmxvb3JUaW1lKHhbY29sdW1uX3NwZWMuZmllbGRJZHhdLGZvcm1hdCxtaW51dGVfdW5pdClcbiAgICAgICAgcmV0dXJuIHhcbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNle1xuICAgICAgZGF0YXNldCA9IGFkZF9kYXRhc2V0X2NvbHVtbihkYXRhc2V0LG91dENvbHVtbiwnZmxvYXQnLGRhdGFzZXQuZGF0YUNvbnRhaW5lci5fcm93cy5tYXAoKHgpID0+IGZsb29yVGltZSh4W2NvbHVtbl9zcGVjLmZpZWxkSWR4XSxmb3JtYXQsbWludXRlX3VuaXQpKSxyZXBsYWNlKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkYXRhc2V0XG5cbn1cblxuXG4vL29ubHkgaW5jbHVkZSB0aG9zZSBkYXRlIG9ubHkgaW4gdGhlIHNlbGVjdGVkIGFyZWE6XG5leHBvcnQgZnVuY3Rpb24gZGF0ZV9maWx0ZXJfcHJvY2VzcyhkYXRhc2V0LGNvbCxkb3csZGF0ZXJhbmdlLHJlbW92ZUhvbGlkYXlGbGFnKXtcbiAgY29uc29sZS5sb2coJ3J1biBkYXRlIGZpbHRlciBwcm9jZXNzJylcblxuXG5cbiAgY29uc3QgY29sX2luZm8gPSBkYXRhc2V0LmZpZWxkcy5maWx0ZXIoKHgpID0+IGNvbCA9PT0geC5uYW1lKTtcblxuXG4gIGlmKGNvbF9pbmZvLmxlbmd0aCA9PT0gMCl7XG4gICAgcmV0dXJuIGRhdGFzZXRcbiAgfVxuXG4gIGlmKEFycmF5LmlzQXJyYXkoY29sKSl7XG4gICAgbGV0IGNvbHVtbl9zcGVjID0gY29sX2luZm9bMF07XG4gICAgZGF0YXNldC5kYXRhQ29udGFpbmVyLl9yb3dzID0gZGF0YXNldC5kYXRhQ29udGFpbmVyLl9yb3dzLmZpbHRlcigoeCkgPT4ge1xuICAgICAgICBkYXRlRmlsdGVyKHhbY29sdW1uX3NwZWMuZmllbGRzSWR4XSxkb3csZGF0ZXJhbmdlLHJlbW92ZUhvbGlkYXlGbGFnKVxuICAgIH0pXG4gIH1cblxuICByZXR1cm4gZGF0YXNldFxuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0aW1lX2ZpbHRlcl9wcm9jZXNzKGRhdGFzZXQsY29sLHN0YXJ0VGltZSxlbmRUaW1lKXtcblxuICBjb25zdCBjb2xfdGFyZ2V0ID0gKCFBcnJheS5pc0FycmF5KGNvbCk/W2NvbF06Y29sKS5tYXAoKHgpPT57XG4gICAgY29sID0gZGF0YXNldC5maWVsZHMuZmlsdGVyKCh4KSA9PiBjb2wgPT09IHgubmFtZSlcbiAgICByZXR1cm4gY29sLmxlbmd0aD49MT9jb2xbMF06bnVsbFxuICB9KVxuXG4gIGRhdGFzZXQuZGF0YUNvbnRhaW5lci5fcm93cyA9IGRhdGFzZXQuZGF0YUNvbnRhaW5lci5fcm93cy5maWx0ZXIoKHgpPT57XG4gICAgcmV0dXJuIGNvbF90YXJnZXQubGVuZ3RoPT09MT90aW1lRmlsdGVyKHhcbiAgICAgIFtjb2xfdGFyZ2V0WzBdLmZpZWxkSWR4XSxbc3RhcnRUaW1lLGVuZFRpbWVdKTp0aW1lUmFuZ2VGaWx0ZXIoeFtjb2xfdGFyZ2V0WzBdXSx4W2NvbF90YXJnZXRbMV1dKVxuICB9KVxuXG4gIHJldHVybiBkYXRhc2V0XG59XG5cblxuXG5cbi8vdGhpcyB3aWxsIGJlIGEgYmF0Y2ggZnVcbmV4cG9ydCBmdW5jdGlvbiBiYXRjaF90ZW1wb3JhbF9maWx0ZXJfcHJvY2VzcyhkYXRhc2V0LHRpbWVDb2xzLGRhdGVDb2xzLHRlbXBvcmFsRmlsdGVyKXtcbiAgLy8gZGF0ZV9jb2xzXG4gIGNvbnN0IHtkb3csZGF0ZVJhbmdlLHJlbW92ZUhvbGlkYXksc3RhcnRUaW1lLGVuZFRpbWUsZmxvb3J9ID0gdGVtcG9yYWxGaWx0ZXI7XG4gIGxldCBuZXdfZGF0YXNldCA9IF8uY2xvbmVEZWVwKGRhdGFzZXQpXG5cbiAgbmV3X2RhdGFzZXQgPSBkYXRlQ29scy5yZWR1Y2UoKGRzLGNvbCk9PiBkYXRlX2ZpbHRlcl9wcm9jZXNzKGRzLGNvbCxkb3csZGF0ZVJhbmdlLHJlbW92ZUhvbGlkYXkpLG5ld19kYXRhc2V0KVxuICBuZXdfZGF0YXNldCA9IHRpbWVDb2xzLnJlZHVjZSgoZHMsY29sKT0+dGltZV9maWx0ZXJfcHJvY2Vzcyhkcyxjb2wsc3RhcnRUaW1lLGVuZFRpbWUpLG5ld19kYXRhc2V0KVxuICBuZXdfZGF0YXNldCA9IHRpbWVDb2xzLnJlZHVjZSgoZHMsY29sKT0+dGltZV9mbG9vcmluZyhkcyx7Y29sOmNvbCxtaW51dGVfdW5pdDpmbG9vcixvdXRDb2x1bW46bnVsbH0pLG5ld19kYXRhc2V0KVxuICBjb25zb2xlLmxvZygnZmluaXNoZWQgdGVtcG9yYWwgZmlsdGVyIHByb2Nlc3MnKVxuICByZXR1cm4gbmV3X2RhdGFzZXRcbn1cblxuIl19